#!/bin/sh

# Script used to lock things (and to unlock them)

usage() {
	printf "\n"
	printf "usage : %s [-e <directory>] [-d <file>]\n" "$0"
	printf "    -e : encrypt following directory\n"
	printf "    -d : decrypt following file\n"
	printf "\n"
}

reqcheck() {
    if [ -z "$(which tar 2>/dev/null)" ] && [ -z "$(which gpg 2>/dev/null)" ] && [ -z "$(which dirname 2>/dev/null)" ]
	then
		printf "You need to have dirname, tar and gpg in your PATH\n" 1>&2
		exit 1
	fi
}

encrypt() {
    if [ -e "$1" ]
    then
        printf "%s" "$1"
        tar -zc "$1" | gpg -qc -o "$1.gpg"
    else
        printf "%s is not a valid target" "$1"
    fi
}

decrypt() {
    if [ -f "$1" ]
    then
        loc=$(dirname "$1")
        gpg -qd "$1" | tar -zxf "$loc" -
    else
        printf "%s is not a valid target" "$1"
    fi
}

reqcheck
if [ $# = 0 ] || [ $# -gt 2 ]
then
	usage
	exit 0
else 
	# erase trailing /
	f=${2%/}
	case "$1" in
		"-e")
			encrypt "$f"
			;;
		"-d")
			decrypt "$f"
			;;
		*)
			usage
			;;
	esac
fi
